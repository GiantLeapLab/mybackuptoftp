#!/bin/bash
# Create individual SQL files for each database. These files
# are imported automatically during an initial provision if
# the databases exist per the import-sql.sh process.

echo
echo "--- Start $0"

set -o nounset
set -e 

TYPE="data"

CNT_PARAMS=6
if [[ $# -lt $CNT_PARAMS ]] ; then 
  echo "Error!!! Must be $CNT_PARAMS parameters"
  exit 1
fi

### Input parameters ###
PERIOD=$1
YEAR=$2
MONTH=$3
DAY=$4
WEEK=$5
DIR_ROOT=$6

NOW="${YEAR}${MONTH}"

### Directories ###
DIR_BIN="${DIR_ROOT}/bin"
DIR_CFG="${DIR_ROOT}/cfg"
DIR_ARC="${DIR_ROOT}/arc"
DIR_LOG="${DIR_ROOT}/log"
DIR_SNAP="${DIR_ROOT}/snapshots"

### GPG settings ###
GPG_USERID=$(cat $DIR_CFG/gpg_userid.txt)
GPG_OPT="-e -r"

### Split settings ###
SPLIT_OPT="-d -a 3 -b $(cat $DIR_CFG/split_size.txt)"

### System Setup ###
GZIP_OPT=-c9
DIRS=$(cat "${DIR_CFG}/dirs_${PERIOD}.lst")
echo "Loaded list directories from ${DIR_CFG}/dirs_${PERIOD}.lst"

#---------------------------------------------------
[ ! -d $DIR_ARC ] && mkdir -p $DIR_ARC || :

for DIR in $DIRS;
do
  if [ -d "$DIR" ] ;
  then 
    echo 
    echo "Backing: $DIR"

    DATA_NAME=$(basename "$DIR")

    FNAME_SNAPSHOT="${DIR_SNAP}/${DATA_NAME}.snapshot"
    FNAME_SNAPSHOT_FULL="$FNAME_SNAPSHOT.full"

#    if [[ "${DAY}" = '01' || "${WEEK}" -eq 0 ]] ; then
    if [[ "${DAY}" = '01' || "${DAY}" = '10' || "${DAY}" = '20' ]] ; then
      rm -f "$FNAME_SNAPSHOT_FULL"
    fi
    rm -f "$FNAME_SNAPSHOT"

    if [[ ! -f "$FNAME_SNAPSHOT_FULL" ]] ; then
      echo 'Snapshot will be created'
      SNAPSHOT="$FNAME_SNAPSHOT_FULL"
      BACKUP_FILE="${DATA_NAME}.${DAY}.full.tgz.gpg"
    else
      echo "cp $FNAME_SNAPSHOT_FULL $FNAME_SNAPSHOT"
      cp "$FNAME_SNAPSHOT_FULL" "$FNAME_SNAPSHOT"
      SNAPSHOT="$FNAME_SNAPSHOT"
      BACKUP_FILE="${DATA_NAME}.${DAY}.tgz.gpg"
    fi
    echo "Snapshot: $SNAPSHOT"

    cd $DIR_ARC
    tar --ignore-failed-read --total --listed-incremental="$SNAPSHOT" -czp "$DIR" \
      | gpg $GPG_OPT "$GPG_USERID" \
      | split $SPLIT_OPT - "${BACKUP_FILE}."
    cd -

    $DIR_BIN/move_file_to_remote $PERIOD $NOW $DAY $TYPE $BACKUP_FILE $DIR_ROOT
    echo
    echo "Dir $DIR backed up..."

    rm -f "$FNAME_SNAPSHOT"
  fi
done    

exit 0