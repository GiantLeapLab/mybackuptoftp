#!/bin/bash
# Create individual SQL files for each database. These files
# are imported automatically during an initial provision if
# the databases exist per the import-sql.sh process.

echo
echo "--- Start $0 $*"

set -o nounset
set -e 

TYPE="db"

CNT_PARAMS=6
if [[ $# -lt $CNT_PARAMS ]] ; then 
  echo "Error!!! Must be $CNT_PARAMS parameters"
  exit 1
fi

### Input parameters ###
PERIOD=$1
YEAR=$2
MONTH=$3
DAY=$4
WEEK=$5
DIR_ROOT=$6

NOW="${YEAR}${MONTH}"

### Directories ###
DIR_BIN="${DIR_ROOT}/bin"
DIR_CFG="${DIR_ROOT}/cfg"
DIR_ARC="${DIR_ROOT}/arc"
DIR_LOG="${DIR_ROOT}/log"

### MySQL Setup ###
DB_HOST=localhost
DB_USER=root
DB_PASS=Q_H9N_wzL76tCE
DB_EXCLUDE="${DIR_CFG}/db_excludes.lst"

### GPG settings ###
GPG_USERID=$(cat $DIR_CFG/gpg_userid.txt)
GPG_OPT="-e -r"

### Split settings ###
SPLIT_OPT="-d -a 3 -b $(cat $DIR_CFG/split_size.txt)"

### System Setup ###
MYSQLDUMP_OPT='--compress'
GREP_OPT="-v -f $DB_EXCLUDE -x"
GZIP_OPT=-c9

#---------------------------------------------------
[ ! -d $DIR_ARC ] && mkdir -p $DIR_ARC || :

echo $(dirname $0)
echo --- See exists DBs ---
DB_AUTH="-h ${DB_HOST} -u ${DB_USER} -p${DB_PASS}"
echo "mysql -e 'show databases'"

echo --- Dump ---
mysql -e 'show databases' $DB_AUTH | sort | grep $GREP_OPT | \
while read DB_NAME; 
do
  echo
  echo "Dumping: $DB_NAME" 
  BACKUP_FILE="${DB_NAME}.sql.gz.gpg" 

  cd $DIR_ARC
  mysqldump $DB_AUTH $MYSQLDUMP_OPT $DB_NAME \
    | gzip $GZIP_OPT \
    | gpg $GPG_OPT "$GPG_USERID" \
    | split $SPLIT_OPT - "${BACKUP_FILE}."
  cd -

  $DIR_BIN/move_file_to_remote $PERIOD $NOW $DAY $TYPE $BACKUP_FILE $DIR_ROOT
  echo
  echo "Database $DB_NAME backed up..."

done
